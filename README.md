# PerFedAvg FedAvg Transformer æ¶ˆè²»è€…é›»åŠ›éœ€æ±‚é æ¸¬ç³»çµ±

## é …ç›®æ¦‚è¿°

åŸºæ–¼ **è¯é‚¦å­¸ç¿’ï¼ˆFederated Learningï¼‰** çš„æ¶ˆè²»è€…é›»åŠ›éœ€æ±‚é æ¸¬ç ”ç©¶é …ç›®ï¼Œä½¿ç”¨ **Transformer æ¨¡å‹** å¯¦ç¾çš„æ™‚åºé æ¸¬ã€‚æœ¬ç³»çµ±æ¡ç”¨ **Per-FedAvgï¼ˆå€‹æ€§åŒ–è¯é‚¦å¹³å‡ï¼‰ ç®—æ³•**ï¼Œæ”¯æŒå¿«é€Ÿå€‹æ€§åŒ–é©æ‡‰ã€‚

### ğŸŒŸ æ ¸å¿ƒç‰¹è‰²

- **ğŸ”’ éš±ç§ä¿è­·**ï¼šæ‰€æœ‰å®¢æˆ¶ç«¯æ•¸æ“šå‡ä¿ç•™åœ¨æœ¬åœ°ï¼Œåƒ…é€²è¡Œæ¨¡å‹åƒæ•¸çš„å…±äº«
- **ğŸ¤– å€‹æ€§åŒ–å­¸ç¿’**ï¼šPer-FedAvgç®—æ³•æ”¯æŒå…¨å±€æ¨¡å‹çš„å¿«é€Ÿå€‹æ€§åŒ–é©æ‡‰
- **âš¡ é«˜æ•ˆå»ºæ¨¡**ï¼šåŸºæ–¼Transformeræ³¨æ„åŠ›æ©Ÿåˆ¶çš„æ™‚åºå»ºæ¨¡ï¼Œè™•ç†25å€‹é›»åŠ›ç‰¹å¾µ
- **ğŸ›¡ï¸ æ™ºèƒ½å„ªåŒ–**ï¼šæ—©åœæ©Ÿåˆ¶èˆ‡å­¸ç¿’ç‡è‡ªå‹•èª¿åº¦ï¼Œé˜²æ­¢éæ“¬åˆ
- **ğŸ“Š å¯è¦–åŒ–åˆ†æ**ï¼šæä¾›æ¨¡å‹æ€§èƒ½è©•ä¼°åŠæ³¨æ„åŠ›æ¬Šé‡çš„å¯è¦–åŒ–å·¥å…·
- **âš™ï¸ éˆæ´»é…ç½®**ï¼šå®Œæ•´çš„YAMLé…ç½®ç³»çµ±ï¼Œæ”¯æŒCUDA/MPS/CPUå¤šè¨­å‚™
- **ğŸ—ï¸ æ¨¡å¡ŠåŒ–è¨­è¨ˆ**ï¼šæ¸…æ™°çš„æ¶æ§‹åˆ†é›¢ï¼Œä¾¿æ–¼æ“´å±•å’Œç¶­è­·


## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

- Python 3.8+
- PyTorch 2.0+
- CUDA, MPSï¼ˆå¯é¸ï¼Œæ”¯æŒ GPU åŠ é€Ÿï¼‰

### å®‰è£æ­¥é©Ÿ

1. **å…‹éš†é …ç›®**
```bash
git clone https://github.com/panhyer36/FedAvgTransformerOPSD.git
cd FedAvgTransformerOPSD
```

2. **å®‰è£ä¾è³´**
```bash
pip install -r requirements.txt
```

3. **æª¢æŸ¥é…ç½®**
```bash
python config.py
```

### é–‹å§‹è¨“ç·´

#### æ–¹æ³•ä¸€ï¼šå¾Œå°è¨“ç·´ï¼ˆæ¨è–¦ï¼‰
```bash
# é–‹å§‹è¨“ç·´
./run.sh

# ç›£æ§è¨“ç·´éç¨‹
tail -f logs/train_*.log

# åœæ­¢è¨“ç·´
./stop.sh
```

#### æ–¹æ³•äºŒï¼šç›´æ¥é‹è¡Œ
```bash
# è¨“ç·´æ¨¡å‹ï¼ˆé»˜èªä½¿ç”¨ config.yamlï¼‰
python train.py

# è¨“ç·´æ¨¡å‹ï¼ˆæŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
python train.py --config custom_config.yaml

# æ¸¬è©¦å’Œå¯è¦–åŒ–ï¼ˆé»˜èªä½¿ç”¨ config.yamlï¼‰
python test.py

# æ¸¬è©¦å’Œå¯è¦–åŒ–ï¼ˆæŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
python test.py --config custom_config.yaml
```

##  é …ç›®æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

```
src/
â”œâ”€â”€ Server.py          #  è¯é‚¦å­¸ç¿’å”èª¿å™¨ï¼ˆæ¨¡å‹èšåˆã€å…¨å±€è¨“ç·´ï¼‰
â”œâ”€â”€ Client.py          #  å®¢æˆ¶ç«¯å¯¦ç¾ï¼ˆæœ¬åœ°è¨“ç·´ã€é©—è­‰è©•ä¼°ï¼‰
â”œâ”€â”€ Model.py           #  Transformeræ™‚åºé æ¸¬æ¨¡å‹
â”œâ”€â”€ DataLoader.py      #  æ™‚åºæ•¸æ“šåŠ è¼‰å™¨
â””â”€â”€ Trainer.py         #  è¨“ç·´å™¨ï¼ˆæ—©åœã€å­¸ç¿’ç‡èª¿åº¦ï¼‰
```

### æ•¸æ“šçµ„ç¹”

```
data/processed/
â”œâ”€â”€ Consumer_01.csv              # ä½å®…å®¢æˆ¶ç«¯æ•¸æ“š
â”œâ”€â”€ Consumer_02.csv              # ä½å®…å®¢æˆ¶ç«¯æ•¸æ“š
â”œâ”€â”€ ...                          # Consumer_03 è‡³ Consumer_50
â”œâ”€â”€ Consumer_50.csv              # ä½å®…å®¢æˆ¶ç«¯æ•¸æ“š
â””â”€â”€ Public_Building.csv          # å…¬å…±å»ºç¯‰å®¢æˆ¶ç«¯æ•¸æ“š
```

### ğŸ“Š æ•¸æ“šç‰¹å¾µè©³ç´°èªªæ˜

æ¯å€‹CSVæ–‡ä»¶åŒ…å«**25å€‹ç‰¹å¾µ**ï¼Œæ¶µè“‹é›»å™¨ä½¿ç”¨ã€å¤©æ°£å’Œç¸½ç”¨é›»é‡ï¼š

#### é›»å™¨ç”¨é›»é‡ç‰¹å¾µï¼ˆ15å€‹ï¼‰
```
AC1, AC2, AC3, AC4           # 4å€‹ç©ºèª¿è¨­å‚™ç”¨é›»é‡
Dish washer                  # æ´—ç¢—æ©Ÿç”¨é›»é‡
Washing Machine              # æ´—è¡£æ©Ÿç”¨é›»é‡  
Dryer                        # çƒ˜ä¹¾æ©Ÿç”¨é›»é‡
Water heater                 # ç†±æ°´å™¨ç”¨é›»é‡
TV                          # é›»è¦–ç”¨é›»é‡
Microwave                   # å¾®æ³¢çˆç”¨é›»é‡
Kettle                      # é›»ç†±æ°´å£ºç”¨é›»é‡
Lighting                    # ç…§æ˜ç”¨é›»é‡
Refrigerator                # å†°ç®±ç”¨é›»é‡
Consumption_Total           # ç¸½æ¶ˆè²»é›»é‡
Generation_Total            # ç¸½ç™¼é›»é‡ï¼ˆå¦‚å¤ªé™½èƒ½ï¼‰
```

#### å¤©æ°£ç‰¹å¾µï¼ˆ9å€‹ï¼‰
```
TemperatureC                # æº«åº¦ï¼ˆæ”æ°åº¦ï¼‰
DewpointC                   # éœ²é»æº«åº¦ï¼ˆæ”æ°åº¦ï¼‰
PressurehPa                 # æ°£å£“ï¼ˆç™¾å¸•ï¼‰
WindSpeedKMH                # é¢¨é€Ÿï¼ˆå…¬é‡Œ/å°æ™‚ï¼‰
WindSpeedGustKMH            # é™£é¢¨é¢¨é€Ÿï¼ˆå…¬é‡Œ/å°æ™‚ï¼‰
Humidity                    # æ¿•åº¦ï¼ˆ%ï¼‰
HourlyPrecipMM              # å°æ™‚é™é›¨é‡ï¼ˆæ¯«ç±³ï¼‰
dailyrainMM                 # æ—¥é™é›¨é‡ï¼ˆæ¯«ç±³ï¼‰
SolarRadiationWatts_m2      # å¤ªé™½è¼»å°„ï¼ˆç“¦ç‰¹/å¹³æ–¹ç±³ï¼‰
```

#### é æ¸¬ç›®æ¨™ï¼ˆ1å€‹ï¼‰
```
Power_Demand                # é›»åŠ›éœ€æ±‚ï¼ˆé æ¸¬ç›®æ¨™ï¼‰
```

### å®¢æˆ¶ç«¯åˆ†ä½ˆ
- **ä½å®…å®¢æˆ¶ç«¯**ï¼š50å€‹ï¼ˆConsumer_01 è‡³ Consumer_50ï¼‰
- **å…¬å…±å»ºç¯‰å®¢æˆ¶ç«¯**ï¼š1å€‹ï¼ˆPublic_Buildingï¼‰
- **ç¸½è¨ˆ**ï¼š51å€‹è¯é‚¦å­¸ç¿’å®¢æˆ¶ç«¯

### è¼¸å‡ºç›®éŒ„

```
ğŸ“ checkpoints/         #  æ¨¡å‹æª¢æŸ¥é»
ğŸ“ plots/              #  å¯è¦–åŒ–åœ–è¡¨
ğŸ“ logs/               #  è¨“ç·´æ—¥èªŒ
```

##  é…ç½®èªªæ˜

### æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š`config.yaml`

#### è¯é‚¦å­¸ç¿’é…ç½®
```yaml
federated_learning:
  algorithm: "per_fedavg"    # è¯é‚¦å­¸ç¿’ç®—æ³•ï¼šper_fedavgï¼ˆå€‹æ€§åŒ–ï¼‰æˆ– fedavgï¼ˆæ¨™æº–ï¼‰
  global_rounds: 100         # å…¨å±€è¨“ç·´è¼ªæ•¸
  client_fraction: 0.1       # æ¯è¼ªåƒèˆ‡å®¢æˆ¶ç«¯æ¯”ä¾‹ï¼ˆ10%ï¼‰
  num_clients: 51            # ç¸½å®¢æˆ¶ç«¯æ•¸é‡ï¼š50å€‹Consumer + 1å€‹Public Building
  eval_interval: 10          # æ¯10è¼ªè©•ä¼°ä¸€æ¬¡
  
  # Per-FedAvg å°ˆç”¨é…ç½®
  per_fedavg:
    meta_step_size: 0.01     # å…ƒå­¸ç¿’æ­¥é•·ï¼ˆÎ±ï¼‰ï¼Œæ§åˆ¶å€‹æ€§åŒ–é©æ‡‰é€Ÿåº¦
    use_second_order: false  # æ˜¯å¦ä½¿ç”¨äºŒéšæ¢¯åº¦ï¼ˆHVPï¼‰ï¼štrue=HVPç‰ˆæœ¬ï¼Œfalse=First-Orderç‰ˆæœ¬  
    hvp_damping: 0.01        # HVPé˜»å°¼ä¿‚æ•¸ï¼Œæé«˜æ•¸å€¼ç©©å®šæ€§ï¼ˆåƒ…HVPç‰ˆæœ¬ç”Ÿæ•ˆï¼‰
```

#### æœ¬åœ°è¨“ç·´é…ç½®
```yaml
local_training:
  local_epochs: 8            # æœ¬åœ°è¨“ç·´è¼ªæ•¸
  learning_rate: 0.0005      # å­¸ç¿’ç‡
  batch_size: 32             # æ‰¹æ¬¡å¤§å°
```

#### æ¨¡å‹æ¶æ§‹é…ç½®
```yaml
model:
  feature_dim: 25            # è¼¸å…¥ç‰¹å¾µç¶­åº¦ï¼ˆåŒ…å«é›»å™¨ç”¨é›»é‡ã€å¤©æ°£ã€ç¸½ç”¨é›»é‡ç­‰ï¼‰
  d_model: 256               # Transformer æ¨¡å‹ç¶­åº¦
  nhead: 8                   # å¤šé ­æ³¨æ„åŠ›æ•¸é‡
  num_layers: 4              # Transformer å±¤æ•¸
  output_dim: 1              # è¼¸å‡ºç¶­åº¦ï¼ˆPower_Demandé æ¸¬ï¼‰
  max_seq_length: 100        # æœ€å¤§åºåˆ—é•·åº¦
  dropout: 0.1               # Dropout æ¯”ç‡
```

#### æ•¸æ“šé…ç½®
```yaml
data:
  data_path: "data/processed"
  input_length: 96           # è¼¸å…¥åºåˆ—é•·åº¦ï¼ˆ96å€‹æ™‚é–“é»ï¼‰
  output_length: 1           # è¼¸å‡ºåºåˆ—é•·åº¦ï¼ˆé æ¸¬1å€‹æ™‚é–“é»ï¼‰
  train_ratio: 0.8           # è¨“ç·´é›†æ¯”ä¾‹ï¼ˆ80%ï¼‰
  val_ratio: 0.1             # é©—è­‰é›†æ¯”ä¾‹ï¼ˆ10%ï¼‰
  test_ratio: 0.1            # æ¸¬è©¦é›†æ¯”ä¾‹ï¼ˆ10%ï¼‰
  target: ["Power_Demand"]   # é æ¸¬ç›®æ¨™
```

#### è¨“ç·´å„ªåŒ–é…ç½®
```yaml
training:
  early_stopping:
    patience: 15             # æ—©åœè€å¿ƒå€¼
    min_delta: 0.001         # æœ€å°æ”¹å–„é–¾å€¼
```

#### å€‹æ€§åŒ–æ¸¬è©¦é…ç½®
```yaml
testing:
  personalization_steps: 3   # Per-FedAvg å€‹æ€§åŒ–é©æ‡‰æ­¥æ•¸
  support_ratio: 0.2         # Support set æ¯”ä¾‹ï¼ˆç”¨æ–¼å€‹æ€§åŒ–é©æ‡‰ï¼‰
  adaptation_lr: 0.001       # å€‹æ€§åŒ–é©æ‡‰å­¸ç¿’ç‡
```

#### è¨­å‚™é…ç½®
```yaml
device:
  type: "auto"               # è‡ªå‹•é¸æ“‡è¨­å‚™ï¼šcudaï¼ˆNVIDIA GPUï¼‰ã€mpsï¼ˆApple Siliconï¼‰ã€cpu
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### è¨“ç·´å‘½ä»¤è©³è§£

| å‘½ä»¤ | åŠŸèƒ½ | èªªæ˜ |
|------|------|------|
| `./run.sh` | å¾Œå°è¨“ç·´ | ä½¿ç”¨ nohup å¾Œå°é‹è¡Œï¼Œè‡ªå‹•å‰µå»ºæ—¥èªŒ |
| `./stop.sh` | åœæ­¢è¨“ç·´ | åœæ­¢è¨“ç·´é€²ç¨‹ |
| `python train.py` | å‰å°è¨“ç·´ | ç›´æ¥åœ¨çµ‚ç«¯é‹è¡Œè¨“ç·´ï¼ˆé»˜èª config.yamlï¼‰ |
| `python train.py --config my_config.yaml` | è‡ªå®šç¾©é…ç½®è¨“ç·´ | ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶é€²è¡Œè¨“ç·´ |
| `python test.py` | æ¨¡å‹æ¸¬è©¦ | åŠ è¼‰æ¨¡å‹é€²è¡Œæ¸¬è©¦å’Œå¯è¦–åŒ–ï¼ˆé»˜èª config.yamlï¼‰ |
| `python test.py --config my_config.yaml` | è‡ªå®šç¾©é…ç½®æ¸¬è©¦ | ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶é€²è¡Œæ¸¬è©¦ |

### ç›£æ§å’Œæ—¥èªŒ

```bash
# å¯¦æ™‚æŸ¥çœ‹è¨“ç·´æ—¥èªŒ
tail -f logs/train_*.log

# æª¢æŸ¥è¨“ç·´ç‹€æ…‹
ps aux | grep python

# æŸ¥çœ‹ GPU ä½¿ç”¨æƒ…æ³ï¼ˆå¦‚æœæœ‰ CUDAï¼‰
nvidia-smi
```

### ğŸ’» è¨­å‚™é…ç½®

ç³»çµ±æ”¯æŒå¤šç¨®è¨ˆç®—è¨­å‚™çš„è‡ªå‹•é¸æ“‡å’Œå„ªåŒ–ï¼š

| è¨­å‚™é¡å‹ | æ”¯æŒå¹³å° | æ€§èƒ½ | é©ç”¨å ´æ™¯ |
|----------|----------|------|-----------|
| **CUDA** | NVIDIA GPU | ğŸš€ æœ€é«˜ | å¤§è¦æ¨¡è¨“ç·´ï¼ˆæ¨è–¦ï¼‰ |
| **MPS** | Apple Silicon (M1/M2/M3) | âš¡ é«˜ | Macç”¨æˆ¶GPUåŠ é€Ÿ |
| **CPU** | æ‰€æœ‰å¹³å° | ğŸŒ åŸºç¤ | ç„¡GPUç’°å¢ƒå‚™ç”¨ |

**è‡ªå‹•è¨­å‚™é¸æ“‡é‚è¼¯**ï¼š
```yaml
device:
  type: "auto"  # ç³»çµ±è‡ªå‹•é¸æ“‡æœ€ä½³å¯ç”¨è¨­å‚™
```

**æ‰‹å‹•æŒ‡å®šè¨­å‚™**ï¼š
```yaml
device:
  type: "cuda"   # å¼·åˆ¶ä½¿ç”¨NVIDIA GPU
  # type: "mps"   # å¼·åˆ¶ä½¿ç”¨Apple Silicon GPU  
  # type: "cpu"   # å¼·åˆ¶ä½¿ç”¨CPU
```

## ğŸ“Š æ¸¬è©¦å’Œè©•ä¼°

### ğŸ¯ é›™é‡è©•ä¼°æ¨¡å¼

ç³»çµ±æä¾›**å…¨å±€æ¨¡å‹è©•ä¼°**å’Œ**å€‹æ€§åŒ–æ¨¡å‹è©•ä¼°**å…©ç¨®æ¨¡å¼ï¼š

#### å…¨å±€æ¨¡å‹è©•ä¼°
```bash
python test.py --config config.yaml
```
ç›´æ¥ä½¿ç”¨è¨“ç·´å¥½çš„å…¨å±€æ¨¡å‹åœ¨å„å®¢æˆ¶ç«¯æ¸¬è©¦é›†ä¸Šè©•ä¼°æ€§èƒ½ã€‚

#### å€‹æ€§åŒ–æ¨¡å‹è©•ä¼°ï¼ˆPer-FedAvgå°ˆç”¨ï¼‰
```bash
python test.py --config config.yaml --personalized
```
æ¨¡æ“¬å¯¦éš›éƒ¨ç½²å ´æ™¯ï¼ŒåŸ·è¡Œå€‹æ€§åŒ–é©æ‡‰å¾Œå†è©•ä¼°æ€§èƒ½ã€‚

### ğŸ“ˆ æ€§èƒ½æŒ‡æ¨™

ç³»çµ±æœƒè¼¸å‡ºä»¥ä¸‹è©³ç´°è©•ä¼°æŒ‡æ¨™ï¼š

#### å›æ­¸æ€§èƒ½æŒ‡æ¨™
- **MSEï¼ˆå‡æ–¹èª¤å·®ï¼‰**ï¼šæ¨¡å‹é æ¸¬ç²¾åº¦çš„å¹³æ–¹èª¤å·®
- **MAEï¼ˆå¹³å‡çµ•å°èª¤å·®ï¼‰**ï¼šé æ¸¬åå·®çš„çµ•å°å€¼å¹³å‡
- **RMSEï¼ˆå‡æ–¹æ ¹èª¤å·®ï¼‰**ï¼šé æ¸¬æº–ç¢ºæ€§çš„æ¨™æº–æŒ‡æ¨™
- **RÂ²ï¼ˆæ±ºå®šä¿‚æ•¸ï¼‰**ï¼šæ¨¡å‹å°æ•¸æ“šè®Šç•°çš„è§£é‡‹èƒ½åŠ›ï¼ˆ0-1ï¼Œè¶Šæ¥è¿‘1è¶Šå¥½ï¼‰

#### Per-FedAvgå°ˆç”¨æŒ‡æ¨™
- **å€‹æ€§åŒ–æ”¹å–„ç‡**ï¼šå€‹æ€§åŒ–å¾Œç›¸å°æ–¼å…¨å±€æ¨¡å‹çš„æ€§èƒ½æå‡
- **é©æ‡‰æ•ˆç‡**ï¼šæ¯å€‹é©æ‡‰æ­¥é©Ÿçš„å¹³å‡æ€§èƒ½æ”¹å–„
- **å®¢æˆ¶ç«¯ç•°è³ªæ€§åˆ†æ**ï¼šä¸åŒå®¢æˆ¶ç«¯çš„å€‹æ€§åŒ–éœ€æ±‚å·®ç•°

### ğŸ¨ å¯è¦–åŒ–è¼¸å‡º

æ¸¬è©¦å®Œæˆå¾Œï¼Œåœ¨ `plots/` ç›®éŒ„ä¸­æœƒè‡ªå‹•ç”Ÿæˆï¼š

#### åŸºç¤è©•ä¼°åœ–è¡¨
1. **é æ¸¬å°æ¯”åœ–**ï¼šçœŸå¯¦å€¼ vs é æ¸¬å€¼æ•£é»åœ–ï¼ˆåŒ…å«RÂ²å€¼ï¼‰
2. **æ™‚åºé æ¸¬åœ–**ï¼šæ™‚é–“åºåˆ—é æ¸¬çµæœå°æ¯”
3. **èª¤å·®åˆ†ä½ˆåœ–**ï¼šé æ¸¬èª¤å·®çš„çµ±è¨ˆåˆ†ä½ˆåˆ†æ
4. **æ³¨æ„åŠ›æ¬Šé‡åœ–**ï¼šTransformer æ³¨æ„åŠ›æ©Ÿåˆ¶å¯è¦–åŒ–

#### Per-FedAvgå°ˆç”¨åœ–è¡¨
5. **å€‹æ€§åŒ–æ”¹å–„åœ–**ï¼šå€‹æ€§åŒ–å‰å¾Œæ€§èƒ½å°æ¯”
6. **å®¢æˆ¶ç«¯ç•°è³ªæ€§åœ–**ï¼šä¸åŒå®¢æˆ¶ç«¯çš„é©æ‡‰æ•ˆæœåˆ†æ
7. **é©æ‡‰æ”¶æ–‚æ›²ç·š**ï¼šå€‹æ€§åŒ–é©æ‡‰éç¨‹çš„æå¤±è®ŠåŒ–

### ğŸ“‹ æ¸¬è©¦å ±å‘Š

ç³»çµ±æœƒç”Ÿæˆè©³ç´°çš„æ¸¬è©¦å ±å‘Šï¼ŒåŒ…å«ï¼š
- æ•´é«”æ€§èƒ½çµ±è¨ˆ
- å„å®¢æˆ¶ç«¯è©³ç´°çµæœ
- å€‹æ€§åŒ–vså…¨å±€æ¨¡å‹å°æ¯”ï¼ˆå¦‚é©ç”¨ï¼‰
- å¯è¦–åŒ–åœ–è¡¨è·¯å¾‘ç´¢å¼•

## ğŸ”¬ æŠ€è¡“ç´°ç¯€

### Per-FedAvg è¯é‚¦å­¸ç¿’æµç¨‹

**Per-FedAvgï¼ˆPersonalized Federated Averagingï¼‰** æ˜¯åŸºæ–¼MAMLï¼ˆModel-Agnostic Meta-Learningï¼‰çš„å€‹æ€§åŒ–è¯é‚¦å­¸ç¿’ç®—æ³•ï¼š

#### ğŸ“‹ æ¨™æº–è¨“ç·´æµç¨‹
1. **åˆå§‹åŒ–**ï¼šServer å‰µå»ºå…¨å±€æ¨¡å‹ä¸¦åˆ†ç™¼çµ¦å®¢æˆ¶ç«¯
2. **å…ƒå­¸ç¿’è¨“ç·´**ï¼šå„å®¢æˆ¶ç«¯åŸ·è¡ŒPer-FedAvgæœ¬åœ°è¨“ç·´ï¼ˆæ”¯æŒFirst-Orderæˆ–HVPç‰ˆæœ¬ï¼‰
3. **åƒæ•¸èšåˆ**ï¼šServer ä½¿ç”¨è¯é‚¦å¹³å‡ç®—æ³•èšåˆåƒæ•¸
4. **æ¨¡å‹åˆ†ç™¼**ï¼šæ›´æ–°å¾Œçš„å…¨å±€æ¨¡å‹åˆ†ç™¼çµ¦æ‰€æœ‰å®¢æˆ¶ç«¯
5. **è¿­ä»£è¨“ç·´**ï¼šé‡è¤‡æ­¥é©Ÿ2-4ç›´åˆ°æ”¶æ–‚

#### ğŸ¯ å€‹æ€§åŒ–é©æ‡‰æµç¨‹
1. **è¼‰å…¥å…¨å±€æ¨¡å‹**ï¼šå®¢æˆ¶ç«¯ç²å¾—è¨“ç·´å¥½çš„å…¨å±€æ¨¡å‹
2. **æ•¸æ“šåˆ†å‰²**ï¼šå°‡æœ¬åœ°æ•¸æ“šåˆ†ç‚ºSupport Setå’ŒQuery Set
3. **å¿«é€Ÿé©æ‡‰**ï¼šåœ¨Support Setä¸ŠåŸ·è¡Œå°‘é‡æ¢¯åº¦æ­¥é©Ÿï¼ˆé€šå¸¸1-5æ­¥ï¼‰
4. **æ€§èƒ½è©•ä¼°**ï¼šåœ¨Query Setä¸Šè©•ä¼°å€‹æ€§åŒ–å¾Œçš„æ¨¡å‹æ€§èƒ½

#### âš¡ Per-FedAvg vs æ¨™æº–FedAvg

| ç‰¹æ€§ | æ¨™æº–FedAvg | Per-FedAvg |
|------|------------|------------|
| ç›®æ¨™ | å­¸ç¿’å–®ä¸€å…¨å±€æ¨¡å‹ | å­¸ç¿’å¯å¿«é€Ÿå€‹æ€§åŒ–çš„æ¨¡å‹ |
| æœ¬åœ°è¨“ç·´ | æ¨™æº–ç›£ç£å­¸ç¿’ | æ¨¡æ“¬å€‹æ€§åŒ–é©æ‡‰çš„å…ƒå­¸ç¿’ |
| é©æ‡‰èƒ½åŠ› | ç„¡å€‹æ€§åŒ– | æ”¯æŒå¿«é€Ÿå€‹æ€§åŒ–é©æ‡‰ |
| è¨ˆç®—è¤‡é›œåº¦ | ä½ | ä¸­ç­‰ |
| ç•°è³ªæ€§è™•ç† | æœ‰é™ | å„ªç§€ |

### ğŸ—ï¸ Transformer æ¨¡å‹æ¶æ§‹

- **ä½ç½®ç·¨ç¢¼**ï¼šæ­£å¼¦-é¤˜å¼¦ä½ç½®ç·¨ç¢¼ï¼Œæ”¯æŒæ™‚åºä¿¡æ¯ç†è§£
- **å¤šé ­æ³¨æ„åŠ›**ï¼š8å€‹æ³¨æ„åŠ›é ­ä¸¦è¡Œè™•ç†ï¼Œæ•æ‰è¤‡é›œæ™‚åºä¾è³´
- **æ¨¡å‹ç¶­åº¦**ï¼š256ç¶­Transformerå…§éƒ¨è¡¨ç¤ºç©ºé–“
- **ç¶²çµ¡æ·±åº¦**ï¼š4å±¤Transformerç·¨ç¢¼å™¨å †ç–Š
- **æ­£å‰‡åŒ–ç­–ç•¥**ï¼š0.1 Dropoutç‡é˜²æ­¢éæ“¬åˆ
- **åºåˆ—è™•ç†**ï¼šæ”¯æŒæœ€é•·100å€‹æ™‚é–“æ­¥çš„åºåˆ—

### ğŸ“Š æ•¸æ“šè™•ç†æµç¨‹

1. **æ•¸æ“šè¼‰å…¥**ï¼šè®€å–CSVæ ¼å¼çš„æ™‚åºé›»åŠ›æ•¸æ“šï¼ˆ25å€‹ç‰¹å¾µï¼‰
2. **æ™‚åºåˆ†å‰²**ï¼šæŒ‰æ™‚é–“é †åºåˆ†å‰²ï¼Œé¿å…æ•¸æ“šæ´©æ¼
3. **ç‰¹å¾µæ¨™æº–åŒ–**ï¼šåŸºæ–¼è¨“ç·´é›†çµ±è¨ˆé€²è¡ŒZ-scoreæ¨™æº–åŒ–
4. **åºåˆ—ç”Ÿæˆ**ï¼š96æ­¥è¼¸å…¥â†’1æ­¥è¼¸å‡ºçš„æ»‘å‹•çª—å£
5. **æ‰¹æ¬¡çµ„ç¹”**ï¼šé«˜æ•ˆçš„DataLoaderæ‰¹æ¬¡è™•ç†

### ğŸ”§ å€‹æ€§åŒ–æ¸¬è©¦æ©Ÿåˆ¶

**Per-FedAvgå°ˆç”¨çš„å€‹æ€§åŒ–è©•ä¼°**ï¼š

```python
# å€‹æ€§åŒ–é©æ‡‰åƒæ•¸
personalization_steps: 3      # é©æ‡‰æ­¥æ•¸
support_ratio: 0.2           # Support setæ¯”ä¾‹  
adaptation_lr: 0.001         # é©æ‡‰å­¸ç¿’ç‡
```

**æ¸¬è©¦æµç¨‹**ï¼š
1. è¼‰å…¥è¨“ç·´å¥½çš„å…¨å±€æ¨¡å‹
2. ç‚ºæ¯å€‹å®¢æˆ¶ç«¯åŸ·è¡Œå€‹æ€§åŒ–é©æ‡‰
3. åœ¨Query setä¸Šè©•ä¼°é©æ‡‰å¾Œæ€§èƒ½
4. ç”Ÿæˆå€‹æ€§åŒ–vså…¨å±€æ¨¡å‹å°æ¯”å ±å‘Š

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. å…§å­˜ä¸è¶³
```bash
# æ¸›å°‘æ‰¹æ¬¡å¤§å°
# ä¿®æ”¹ config.yaml
local_training:
  batch_size: 16  # å¾ 32 æ¸›å°‘åˆ° 16
```

#### 2. CUDA/MPS éŒ¯èª¤
```bash
# å¼·åˆ¶ä½¿ç”¨ CPU
# ä¿®æ”¹ config.yaml
device:
  type: "cpu"

# æª¢æŸ¥è¨­å‚™å¯ç”¨æ€§
python -c "import torch; print(f'CUDA: {torch.cuda.is_available()}, MPS: {torch.backends.mps.is_available()}')"
```

#### 3. Per-FedAvg è¨“ç·´ä¸ç©©å®š
```bash
# èª¿æ•´å…ƒå­¸ç¿’æ­¥é•·
# ä¿®æ”¹ config.yaml
federated_learning:
  per_fedavg:
    meta_step_size: 0.005  # å¾ 0.01 é™ä½åˆ° 0.005
    use_second_order: false  # ä½¿ç”¨First-Orderç‰ˆæœ¬æé«˜ç©©å®šæ€§
```

#### 4. è¨“ç·´ç„¡æ³•æ”¶æ–‚
```bash
# èª¿æ•´å­¸ç¿’ç‡å’Œè¨“ç·´åƒæ•¸
local_training:
  learning_rate: 0.0001  # é™ä½å­¸ç¿’ç‡
  local_epochs: 4        # æ¸›å°‘æœ¬åœ°è¨“ç·´è¼ªæ¬¡
```

#### 5. æ•¸æ“šåŠ è¼‰éŒ¯èª¤
```bash
# æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
python -c "import pandas as pd; pd.read_csv('data/processed/Consumer_01.csv').info()"
```


## ğŸ“¦ é …ç›®ä¾è³´

### æ ¸å¿ƒä¾è³´

| å¥—ä»¶ | ç‰ˆæœ¬è¦æ±‚ | åŠŸèƒ½ |
|------|----------|------|
| **torch** | â‰¥2.0.0 | PyTorchæ·±åº¦å­¸ç¿’æ¡†æ¶ |
| **torchvision** | â‰¥0.15.0 | è¨ˆç®—æ©Ÿè¦–è¦ºå·¥å…·ï¼ˆä¾è³´é …ï¼‰ |
| **numpy** | â‰¥1.21.0 | é«˜æ€§èƒ½æ•¸å€¼è¨ˆç®— |
| **pandas** | â‰¥1.3.0 | æ•¸æ“šè™•ç†å’Œåˆ†æ |
| **scikit-learn** | â‰¥1.0.0 | æ©Ÿå™¨å­¸ç¿’å·¥å…·å’Œè©•ä¼°æŒ‡æ¨™ |

### å¯è¦–åŒ–ä¾è³´
| å¥—ä»¶ | ç‰ˆæœ¬è¦æ±‚ | åŠŸèƒ½ |
|------|----------|------|
| **matplotlib** | â‰¥3.5.0 | åŸºç¤åœ–è¡¨ç¹ªè£½ |
| **seaborn** | â‰¥0.11.0 | çµ±è¨ˆåœ–è¡¨å’Œç¾åŒ– |

### å·¥å…·ä¾è³´
| å¥—ä»¶ | ç‰ˆæœ¬è¦æ±‚ | åŠŸèƒ½ |
|------|----------|------|
| **pyyaml** | â‰¥6.0 | YAMLé…ç½®æ–‡ä»¶è§£æ |
| **psutil** | â‰¥5.8.0 | ç³»çµ±è³‡æºç›£æ§ |
| **tensorboard** | â‰¥2.10.0 | å¯é¸ï¼šè¨“ç·´éç¨‹å¯è¦–åŒ– |
| **python-dotenv** | - | ç’°å¢ƒè®Šé‡ç®¡ç† |
| **requests** | - | HTTPè«‹æ±‚æ”¯æŒ |

### ğŸš€ å¿«é€Ÿå®‰è£

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨requirements.txtï¼ˆæ¨è–¦ï¼‰
```bash
pip install -r requirements.txt
```

#### æ–¹æ³•äºŒï¼šæ‰‹å‹•å®‰è£æ ¸å¿ƒä¾è³´
```bash
# åŸºç¤PyTorchç’°å¢ƒ
pip install torch>=2.0.0 torchvision>=0.15.0

# æ•¸æ“šè™•ç†
pip install numpy>=1.21.0 pandas>=1.3.0 scikit-learn>=1.0.0

# å¯è¦–åŒ–
pip install matplotlib>=3.5.0 seaborn>=0.11.0

# é…ç½®å’Œå·¥å…·
pip install pyyaml>=6.0 psutil>=5.8.0
```

### ğŸ’¡ GPUåŠ é€Ÿè¨­ç½®

#### NVIDIA CUDA
```bash
# æª¢æŸ¥CUDAå¯ç”¨æ€§
python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"

# å¦‚éœ€CUDAæ”¯æŒï¼Œå®‰è£å°æ‡‰ç‰ˆæœ¬çš„PyTorch
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

#### Apple Silicon (MPS)
```bash
# MacOSç”¨æˆ¶è‡ªå‹•æ”¯æŒMPSï¼Œç„¡éœ€é¡å¤–å®‰è£
python -c "import torch; print(f'MPS available: {torch.backends.mps.is_available()}')"
```
